# CLAUDE.md — resilient-http

> Claude Code context file for the resilient-http npm package

## Purpose & Boundaries

**What this library does:**
- Provides framework-agnostic HTTP resilience patterns for Node.js, Bun, and browsers
- Implements retry logic with exponential backoff, linear backoff, and constant backoff strategies
- Implements jitter algorithms (full, equal, decorrelated) to prevent thundering herd problems
- Provides circuit breaker pattern for preventing cascading failures
- Extracts and standardizes errors from various HTTP clients (Axios, Fetch, Got, Undici, node-fetch)
- Zero runtime dependencies, tree-shakeable design

**Non-goals / What this is NOT:**
- NOT an HTTP client (wraps any HTTP client)
- NOT a backend service or API (it's a library/npm package)
- Does NOT include frontend/UI components
- Does NOT include database, ORM, or messaging infrastructure
- Does NOT enforce specific architectural patterns (hexagonal, DDD, etc.)

**External Dependencies:**
- RxJS is an optional peer dependency for observable integrations
- Works with any HTTP client (Axios, fetch, got, undici, node-fetch)

---

## Repo Map (Library Structure)

```
resilient-http/
├── src/                          # Source code
│   ├── index.ts                  # Main entry - barrel exports
│   ├── types/
│   │   └── index.ts              # All TypeScript type definitions
│   ├── core/
│   │   ├── index.ts              # Core algorithms barrel export
│   │   ├── backoff.ts            # Backoff strategies (exponential, linear, constant)
│   │   └── jitter.ts             # Jitter algorithms (full, equal, decorrelated, none)
│   ├── retry/
│   │   ├── index.ts              # Retry barrel export
│   │   └── retry.ts              # retry(), retryWithSignal(), withRetry()
│   ├── circuit-breaker/
│   │   ├── index.ts              # Circuit breaker barrel export
│   │   └── circuit-breaker.ts    # CircuitBreaker class, withCircuitBreaker()
│   ├── errors/
│   │   ├── index.ts              # Error barrel export
│   │   └── extractor.ts          # Error extraction, classification, retry predicates
│   └── utils/
│       ├── index.ts              # Utilities barrel export
│       ├── sleep.ts              # sleep(), sleepWithAbort()
│       └── random.ts             # randomBetween(), randomFloatBetween()
├── tests/                        # Test files
│   ├── backoff.test.ts           # Backoff strategy tests
│   ├── jitter.test.ts            # Jitter algorithm tests
│   ├── error-extraction.test.ts  # Error extraction tests
│   └── circuit-breaker.test.ts   # Circuit breaker tests
├── docs/
│   └── ARCHITECTURE.md           # Architecture design document
├── dist/                         # Build output (generated, gitignored)
├── package.json                  # Package manifest
├── tsconfig.json                 # TypeScript configuration
├── tsup.config.ts                # Build configuration (tsup)
└── .github/workflows/            # CI/CD
    ├── ci.yml                    # CI pipeline (Node 18/20/22 + Bun)
    └── publish.yml               # npm publish on release
```

---

## Tech Stack

| Component | Technology |
|-----------|------------|
| **Language** | TypeScript 5.3+ |
| **Runtime** | Node.js 18+ / Bun 1.0+ / Browsers (ESM) |
| **Module Format** | Dual ESM + CJS (ESM primary) |
| **Build Tool** | tsup 8.x |
| **Type Definitions** | .d.ts generated by tsup |
| **Test Runner** | Bun test (primary), Node.js test runner (secondary) |
| **Package Manager** | Yarn (CI uses frozen lockfile) |
| **Target** | ES2020 |

---

## Golden Commands

All commands verified from `package.json` scripts:

```bash
# Install dependencies
yarn install

# Type checking (no emit)
yarn typecheck

# Build (ESM + CJS + types)
yarn build

# Watch mode for development
yarn dev

# Run tests with Bun
yarn test         # or: bun test

# Run tests with Node.js
yarn test:node    # node --import tsx --test tests/*.test.ts

# Lint source files
yarn lint

# Format source files
yarn format
```

**Pre-publish:**
```bash
yarn build        # Runs automatically via prepublishOnly
```

---

## Architectural Conventions

This library follows a **modular, tree-shakeable design**:

1. **Barrel Exports**: Each module has an `index.ts` that re-exports public APIs
2. **No Circular Dependencies**: Modules follow a clear dependency hierarchy:
   - `utils` → base utilities (no deps)
   - `types` → type definitions only
   - `core` → depends on `types`, `utils`
   - `errors` → depends on `types`
   - `retry` → depends on `core`, `errors`, `utils`
   - `circuit-breaker` → depends on `types`
3. **Tree-Shakeable**: `sideEffects: false` in package.json enables dead code elimination
4. **Dual Module Output**: Both ESM and CJS builds for maximum compatibility
5. **Conditional Exports**: Package exports support different environments (Node, Bun, browsers)

**Rules of Engagement:**
- Keep each module cohesive and focused on a single responsibility
- Avoid adding runtime dependencies (zero-dependency is a key feature)
- All public APIs must be typed with JSDoc documentation
- Use strategy patterns for extensibility (backoff, jitter, error extraction)
- HTTP client detection should be non-intrusive and fallback gracefully

**Architecture Changes:**
- New resilience patterns or significant API changes should be documented in `docs/ARCHITECTURE.md`
- Consider backwards compatibility for any public API changes
- For complex additions, consult the `backend-software-architect` subagent

---

## Interfaces & Contracts

### Public API Entry Points

**Main Entry (`resilient-http`):**
```typescript
import { retry, CircuitBreaker, extractError } from 'resilient-http';
```

**Sub-module Imports (tree-shakeable):**
```typescript
import { retry } from 'resilient-http/retry';
import { CircuitBreaker } from 'resilient-http/circuit-breaker';
import { extractError } from 'resilient-http/errors';
import { calculateBackoff, applyJitter } from 'resilient-http/core';
import { sleep } from 'resilient-http/utils';
```

### Core Types (from `src/types/index.ts`)

| Type | Purpose |
|------|---------|
| `RetryOptions` | Configuration for retry behavior |
| `CircuitBreakerOptions` | Configuration for circuit breaker |
| `CircuitState` | 'closed' \| 'open' \| 'half-open' |
| `CircuitMetrics` | Metrics for monitoring |
| `StandardizedError` | Unified error representation |
| `ErrorClassification` | Error category for retry decisions |
| `BackoffStrategy` | 'exponential' \| 'linear' \| 'constant' |
| `JitterStrategy` | 'full' \| 'equal' \| 'decorrelated' \| 'none' |

### Adding New Features

1. **New Backoff Strategy**: Add function to `src/core/backoff.ts`, update `calculateBackoff()` switch
2. **New Jitter Algorithm**: Add function to `src/core/jitter.ts`, update `applyJitter()` switch
3. **New HTTP Client Support**: Add extractor function in `src/errors/extractor.ts`, update `detectClientType()` and `extractError()`
4. **New Resilience Pattern**: Create new module under `src/`, add to main exports

---

## Security & Compliance

- **Secrets**: None stored or processed (this is a utility library)
- **Error Extraction**: Error messages may contain URLs; consider sanitization in logging contexts
- **No PII Processing**: Library does not inspect request/response bodies (except error messages)
- **Timeout Enforcement**: All retry operations respect configured timeouts to prevent infinite loops
- **Circuit Breaker Limits**: Configurable thresholds prevent resource exhaustion

---

## Observability

This library provides hooks for observability integration:

```typescript
// Retry callbacks
onRetry?: (error: unknown, attempt: number, nextDelay: number) => void;
onFailure?: (error: unknown, attempts: number) => void;

// Circuit breaker callbacks
onOpen?: () => void;
onClose?: () => void;
onHalfOpen?: () => void;

// Logger interface (compatible with console, winston, pino, etc.)
interface Logger {
  error(message: string, context?: Record<string, unknown>): void;
  warn(message: string, context?: Record<string, unknown>): void;
  info?(message: string, context?: Record<string, unknown>): void;
  debug?(message: string, context?: Record<string, unknown>): void;
}
```

---

## Git & Delivery Conventions

**Branch Naming:**
- `feature/*` - New features
- `fix/*` - Bug fixes
- `hotfix/*` - Urgent production fixes

**Commit Messages:**
- Follow conventional commits: `feat:`, `fix:`, `docs:`, `test:`, `chore:`
- Example: `feat: add decorrelated jitter strategy`

**Pull Requests:**
- Run `yarn typecheck && yarn build && yarn test` before submitting
- Update CHANGELOG.md under `[Unreleased]` section
- Update README.md if public API changes

**Releases:**
- Triggered by GitHub release creation
- Publishes to npm with provenance

---

## Subagent Orchestration

| Intent | Subagent | Output |
|--------|----------|--------|
| Architecture/design decisions | `backend-software-architect` | Architecture proposal + risk analysis |
| Test strategy and unit tests | `backend-test-architect` | Test plan + critical cases |
| Acceptance criteria validation | `qa-criteria-validator` | QA checklist + validation approach |
| Documentation + commit + push | `feature-docs-and-commit` | `/docs/{feature}.md` + CHANGELOG + commit |

**Escalation Rules:**
- If requirements unclear → Ask user for clarification
- If adding new public API → Route to architect for API design review
- If changes affect error classification → Review retryability logic carefully
- If performance-sensitive changes → Benchmark before/after

---

## When to Ask Humans

- Business logic for retry predicates (what errors to retry)
- Breaking API changes (major version bump required)
- Adding new external dependencies (zero-dependency is a selling point)
- Release versioning decisions (semver)
- Security considerations for error message exposure

---

## Known TBDs

- RxJS observable operators (`src/observable/`) - documented in architecture but not yet implemented
- Additional HTTP client extractors (superagent, request) - currently fall back to generic

---

## Quick Reference

```bash
# Development workflow
yarn install          # Install deps
yarn dev              # Watch mode
yarn test             # Run tests
yarn typecheck        # Type check
yarn build            # Build for release

# Test specific file
bun test tests/retry.test.ts
node --import tsx --test tests/retry.test.ts
```
